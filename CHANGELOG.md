# v2 アップデート - 変更内容

## 📅 更新日: 2026-01-15

## ✨ 新機能

### 1. 矢印ツール (➡️)
- **ショートカット**: `A` キー
- **使い方**: ドラッグして矢印を描画
- **用途**: フローや方向を示す注釈に最適

### 2. 番号スタンプツール (🔢)
- **ショートカット**: `N` キー  
- **使い方**: クリックで番号付き円を配置
- **機能**: 自動で番号が増加 (①②③...)
- **用途**: 手順の説明や順序の表示に最適

### 3. カラーピッカー (🎨)
- **場所**: ツールバー中央
- **機能**: 枠線、矢印、番号スタンプの色を自由に変更
- **デフォルト**: #ff3b30 (赤)

### 4. 線の太さ調整
- **場所**: カラーピッカーの隣
- **範囲**: 1px - 10px
- **デフォルト**: 3px
- **対象**: 枠線と矢印

## 🐛 バグ修正

### テキスト入力の改善
**問題**: テキスト入力時にフォーカスが外れると即座に閉じてしまう

**修正内容**:
- `blur` イベントに100msの遅延を追加
- Enterキーとblurイベントの競合を解消
- テキスト入力中のショートカットキーを無効化 (`e.stopPropagation()`)

**結果**: テキスト入力が安定して動作するようになった

## 🎨 UI/UX改善

### ツールバーの拡張
- 矢印ボタンの追加
- 番号ボタンの追加
- カラーピッカーセクションの追加
- 線の太さスライダーの追加

### 情報表示の改善
- 次の番号を表示 (例: "次の番号: 3")
- オブジェクト数の表示継続

## 📊 データ構造の変更

### 新しいオブジェクトタイプ

#### 矢印オブジェクト
```javascript
{
    type: 'arrow',
    x1, y1,          // 始点
    x2, y2,          // 終点
    strokeStyle,     // 色
    lineWidth        // 太さ
}
```

#### 番号スタンプオブジェクト
```javascript
{
    type: 'number',
    x, y,            // 位置
    number,          // 番号 (1, 2, 3...)
    radius: 20,      // 円の半径
    fillStyle,       // 背景色
    textColor: '#fff',  // テキスト色
    fontSize: 18,
    fontWeight: 'bold'
}
```

### 履歴管理の拡張
- `numberCounter` を履歴に含めるように変更
- Undo/Redo時に番号カウンターも復元

## 🔧 技術的な改善

### イベント処理
- テキスト入力のタイムアウト管理
- イベント伝播の制御 (`stopPropagation`)
- フォーカス管理の改善

### 描画処理
- 矢印の描画アルゴリズム実装
- 番号スタンプの円形描画
- 選択ハンドルの表示制御 (矢印と番号は点線枠のみ)

### 当たり判定
- 矢印の線に対する距離計算
- 番号スタンプの円形当たり判定

## 📝 ショートカットキーの追加

| キー | 機能 |
|------|------|
| `A` | 矢印ツール |
| `N` | 番号スタンプ |

## 🎯 使用例

### 手順説明の場合
1. 番号スタンプツール (`N`) で ①②③ を配置
2. 矢印ツール (`A`) で順序を示す
3. テキストツール (`T`) で説明を追加

### 強調表示の場合
1. カラーピッカーで目立つ色を選択 (例: 黄色 #ffcc00)
2. 枠線ツール (`R`) で重要箇所を囲む
3. 矢印で注目点を指す

## 🚀 パフォーマンス

- 新機能追加後もパフォーマンスは維持
- ファイルサイズ: 24KB → 33KB (9KB増加)
- 描画速度: 変化なし

## 🔜 今後の予定

### 優先度: 高
- [ ] テキストの複数行対応
- [ ] オブジェクトの重ね順変更
- [ ] 番号のリセット機能

### 優先度: 中
- [ ] ぼかし（モザイク）ツール
- [ ] カスタムフォントサイズ
- [ ] オブジェクトの複製

---

**総行数**: 2,195行 → 2,500行 (約14%増)  
**Git commit**: 5コミット  
**テスト状況**: ✅ 動作確認済み
