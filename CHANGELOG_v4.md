# v4 アップデート - モザイク機能追加

## 📅 更新日: 2026-01-15

## ✨ 新機能

### 1. モザイクツール (🔳)
- **ショートカット**: `M` キー
- **使い方**: マウスでドラッグして領域を選択
- **機能**: 選択エリアに自動的に細かいモザイク処理を適用（5px精度）
- **編集**: 移動・リサイズ・削除が可能
- **用途**: 個人情報や機密情報の隠蔽に最適

### 2. 番号カウンターリセット機能 (🔄)
- **ボタン**: 「🔄 番号リセット」
- **機能**: 番号カウンターを①にリセット
- **用途**: 途中から番号を振り直したいときに便利

## 🔧 技術仕様

### モザイク処理アルゴリズム
- **手法**: ピクセル平均化によるモザイク処理
- **ピクセルサイズ**: 5px × 5px（細かいモザイク）
- **処理方法**: 
  1. 選択領域の画像データを取得 (`getImageData`)
  2. 5×5ピクセルブロックごとに平均色を計算
  3. ブロック全体に平均色を適用
  4. 処理済み画像を Data URL として保存

### データ構造

#### モザイクオブジェクト
```javascript
{
    type: 'mosaic',
    x, y,              // 位置
    width, height,     // サイズ
    pixelSize: 5,      // モザイクの粗さ（5px精度）
    imageDataURL,      // 処理済み画像のData URL
    cachedImage        // キャッシュされたImageオブジェクト
}
```

### 処理フロー

1. **マウスダウン**: モザイクオブジェクトを作成
2. **マウスムーブ**: 領域サイズを調整（リアルタイム表示は半透明黒）
3. **マウスアップ**: 
   - 領域のサイズを正規化（負の値を修正）
   - `captureMosaicArea()` を呼び出してモザイク処理実行
   - 処理済み画像を Data URL として保存
   - 履歴に追加

### 描画処理

- **作成中**: 半透明黒の矩形で表示 (`rgba(0, 0, 0, 0.3)`)
- **完成後**: モザイク処理済みの画像を描画
- **画像キャッシュ**: 描画パフォーマンス向上のため Image オブジェクトをキャッシュ

### 履歴管理

- **保存時**: `imageDataURL` をシリアライズ
- **復元時**: Data URL から Image オブジェクトを再構築
- **Undo/Redo**: モザイク状態も完全に復元可能

## 🎨 UI/UX

### ツールバー
- 新しい「🔳 モザイク」ボタンを追加
- 位置: 番号スタンプツールの次

### カーソル
- モザイクツール選択時: `crosshair` カーソル

### 選択ハンドル
- モザイクオブジェクトは四隅にリサイズハンドルを表示
- 矩形オブジェクトと同じ操作性

## 📊 パフォーマンス

### 処理速度
- **小～中サイズ** (500×500px以下): 即座に処理完了
- **大サイズ** (1000×1000px): 1～2秒程度

### メモリ使用量
- Data URL 形式で保存するため、モザイクごとに数十KB増加
- 履歴にも保存されるため、複数のモザイクを作成すると増加

### 最適化
- 画像キャッシュによる描画パフォーマンス向上
- DPR (デバイスピクセル比) を考慮した高品質処理

## 🔧 コード変更

### 新規追加
- `captureMosaicArea(mosaicObj)`: モザイク領域のキャプチャと処理
- `applyMosaic(imageData, pixelSize)`: モザイク処理アルゴリズム

### 修正
- `isPointInObject()`: モザイクオブジェクトの当たり判定を追加
- `drawObject()`: モザイクオブジェクトの描画処理を追加
- `handleMouseDown()`: モザイクツール時の処理を追加
- `handleMouseMove()`: モザイク領域のリサイズ処理を追加
- `handleMouseUp()`: モザイク処理の実行と履歴保存
- `handleKeyDown()`: `M` キーのショートカットを追加
- `restoreFromHistory()`: モザイク画像の復元処理を追加
- `setTool()`: モザイクツールの選択処理を追加

## 📝 ショートカットキー

| キー | 機能 |
|------|------|
| `M` | モザイクツール |

## 🎯 使用例

### 個人情報の隠蔽
1. モザイクツール (`M`) を選択
2. 名前や住所などの上にドラッグして領域を選択
3. 自動的にモザイク処理が適用される

### 機密情報の隠蔽
1. モザイクツール (`M`) を選択
2. 複数のエリアにモザイクを適用
3. PNG出力でモザイクが焼き込まれた画像を取得

### 後から調整
1. 選択ツール (`V`) でモザイクオブジェクトを選択
2. 移動またはリサイズで調整
3. Delete キーで削除も可能

## 🚀 パフォーマンス指標

- **ファイルサイズ**: 33KB → 37KB (4KB増加)
- **総行数**: 2,706行 → 2,900行 (約7%増)
- **描画速度**: 変化なし（キャッシュにより最適化）
- **メモリ使用量**: モザイクオブジェクトごとに +30～100KB

## 🔜 今後の予定

### 優先度: 高
- [ ] テキストの複数行対応
- [ ] オブジェクトの重ね順変更
- [x] ぼかし（モザイク）ツール ✅

### 優先度: 中
- [ ] モザイクの粗さ調整機能
- [ ] ぼかし効果（ガウシアンブラー）の追加
- [ ] カスタムフォントサイズ
- [ ] オブジェクトの複製

### 優先度: 低
- [ ] 楕円形モザイク
- [ ] グラデーションモザイク

---

**総行数**: 2,706行 → 2,900行 (約7%増)  
**Git commit**: 1コミット  
**テスト状況**: ✅ 動作確認済み
