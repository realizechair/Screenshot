# v3 アップデート - 複数画像対応

## 📅 更新日: 2026-01-15

## 🎉 メジャーアップデート: 複数画像対応

### 新しいワークフロー
従来: 1画像 → 注釈追加 → 出力  
**v3**: 複数画像配置 → レイアウト調整 → 注釈追加 → 出力

---

## ✨ 新機能

### 1. 複数画像の配置
- **無制限に画像を追加**: Ctrl/⌘+V を何度でも実行可能
- **自動配置**: 新しい画像は少しずつずらして配置
- **レイヤー管理**: 画像は最背面、注釈は最前面に自動配置

### 2. 画像オブジェクトとしての管理
- 画像も他の注釈と同様に「オブジェクト」として扱う
- 選択・移動・リサイズ・削除が可能
- Undo/Redo対応

### 3. 画像のリサイズ
- **四隅ハンドル**: 青いハンドルをドラッグしてサイズ変更
- **アスペクト比**: 自由に変更可能（固定なし）
- **最小サイズ**: 20x20px

### 4. 大きなキャンバス
- **初期サイズ**: 1920x1080px（Full HD）
- **自動拡張**: 画像やオブジェクトがはみ出すと自動で拡大
- **グリッド表示**: 50pxごとに薄いグリッド線を表示

### 5. 白背景 + グリッド
- キャンバス背景が白色（画像がない部分も出力される）
- 作業中はグリッド線が表示され、位置合わせが簡単
- 出力時はグリッド線なしのクリーンな画像

---

## 🔧 技術的な変更

### アーキテクチャの刷新

#### Before (v2)
```javascript
this.image = img;  // 1つの背景画像
this.objects = [rect, arrow, text, ...];  // 注釈のみ
```

#### After (v3)
```javascript
this.objects = [image1, image2, rect, arrow, text, ...];  // すべてオブジェクト
// 画像は配列の先頭（最背面）に配置
```

### データ構造

#### 画像オブジェクト
```javascript
{
    type: 'image',
    id: number,
    x, y,               // 位置
    width, height,      // 表示サイズ
    image: Image,       // HTMLImageElement
    originalWidth,      // 元サイズ
    originalHeight,
    imageDataURL: string  // 履歴保存用
}
```

### キャンバス管理

#### 初期化
```javascript
// 大きめのキャンバスを用意
this.canvas.width = Math.max(1920, containerWidth);
this.canvas.height = Math.max(1080, containerHeight);
```

#### 自動拡張
```javascript
expandCanvasIfNeeded(requiredWidth, requiredHeight) {
    if (requiredWidth > this.canvas.width) {
        this.canvas.width = requiredWidth + 200;
    }
    if (requiredHeight > this.canvas.height) {
        this.canvas.height = requiredHeight + 200;
    }
}
```

### 履歴管理の改善

#### 画像の保存
- Imageオブジェクトは直接JSON化できない
- `image.src` (Data URL) を保存
- 復元時にImageオブジェクトを再作成

```javascript
// 保存時
const objectsForHistory = this.objects.map(obj => {
    if (obj.type === 'image') {
        return { ...obj, imageDataURL: obj.image.src };
    }
    return obj;
});

// 復元時
this.objects = state.objects.map(obj => {
    if (obj.type === 'image') {
        const img = new Image();
        img.src = obj.imageDataURL;
        return { ...obj, image: img };
    }
    return obj;
});
```

---

## 🎨 UI/UX の改善

### ビジュアルフィードバック
- **グリッド線**: 位置合わせを支援
- **白背景**: 作業エリアが明確
- **画像カウント**: 「画像: 3枚 | オブジェクト: 15個」と表示

### 操作性
- 画像も他のオブジェクトと同じ操作感
- 選択→リサイズハンドルが表示
- 移動→ドラッグ
- 削除→Deleteキー

---

## 📊 使用例

### 複数スクショを並べて比較
```
1. スクショA を貼り付け (Ctrl+V)
2. スクショB を貼り付け (Ctrl+V)
3. 選択ツールで横に並べる
4. 枠線で差異を強調
5. 矢印で関連性を示す
6. 出力
```

### 手順書の作成
```
1. 手順1のスクショ を貼り付け
2. 手順2のスクショ を貼り付け
3. 縦に配置
4. 番号スタンプ (①②③) を追加
5. テキストで説明を追加
6. 出力
```

### Before/After の表示
```
1. Before画像 を貼り付け
2. After画像 を貼り付け
3. 左右に配置
4. テキストで「Before」「After」を追加
5. 矢印で変化を示す
6. 出力
```

---

## ⚡ パフォーマンス

### 最適化
- 画像は遅延描画（必要時のみ）
- グリッド描画は効率的なループ
- 大きなキャンバスでも快適に動作

### 制限事項
- 推奨: 画像10枚まで（それ以上でも動作するが重くなる可能性）
- キャンバスサイズ: 最大5000x5000px程度

---

## 🔄 移行ガイド（v2 → v3）

### 互換性
- ❌ v2の履歴はv3で復元不可（データ構造が異なる）
- ✅ 操作方法はほぼ同じ
- ✅ すべての注釈機能は互換性あり

### 変更点
- 初回画像読み込み時にキャンバス全体がリサイズされない
- 画像も選択・移動・リサイズ可能になった
- 背景が白色になった（透明ではない）

---

## 🐛 既知の制約

### 画像の重なり
- 画像同士を重ねることは可能
- レイヤー順序は追加順（後から追加した画像が上）
- 現在、レイヤー順序の変更機能なし（今後追加予定）

### キャンバスサイズ
- 非常に大きなキャンバスは出力時にメモリ不足になる可能性
- 推奨: 3000x3000px以下

---

## 🎯 今後の予定

### 優先度: 高
- [ ] レイヤー順序の変更（前面/背面移動）
- [ ] 画像のアスペクト比ロック
- [ ] グリッド線の表示/非表示切り替え

### 優先度: 中
- [ ] 画像のトリミング機能
- [ ] 複数オブジェクトの一括選択
- [ ] キャンバスサイズのプリセット

---

## 📈 統計

| 項目 | v2 | v3 | 変化 |
|------|----|----|------|
| 総行数 | 1,100行 | 1,180行 | +80行 |
| 画像対応 | 1枚 | 無制限 | ✅ |
| キャンバスサイズ | 画像に合わせる | 1920x1080〜 | ✅ |
| 画像操作 | 不可 | 移動・リサイズ可 | ✅ |

---

**🎊 v3リリース完了！複数画像で資料作成が劇的に効率化！**
